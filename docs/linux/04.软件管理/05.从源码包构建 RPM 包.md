---
title: 从源码包构建 RPM 包
sidebarPrefix: <i class='iconfont icon-goujian'> </i>
---

从源码包构建 RPM 包指的是将软件的源代码转换成一个 RPM 格式的软件包的过程。构建 RPM 包不仅能够简化软件的安装和卸载过程，还能自动处理依赖关系，确保系统的稳定性和安全性。此外，RPM 包的标准化特性使得软件能够在不同的 RPM 兼容系统间轻松移植，极大地方便了软件的分发和维护。

将一个源码包转换为 RPM 包这个过程，这不仅涉及到编译源代码，还包括编写 SPEC 文件、配置构建环境、以及使用 `rpmbuild` 命令（或者使用 `mock` 工具）来生成最终的 RPM 包。

> [!TIP]源码包 和 SRPM
> 源码包（通常为 `.tar.gz`/`.tar.xz` 格式）是软件原始源代码的压缩包，仅包含程序源码、配置脚本及说明文档，无打包逻辑配置，需手动编写 SPEC 文件、处理编译依赖才能构建为 RPM 包，适配性强但打包流程繁琐。
>
> SRPM（源码 RPM 包，后缀为 `.src.rpm`）是 RPM 生态的标准化源码包，不仅包含软件原始源码，还内置了 SPEC 配置文件、补丁文件等打包所需资源。它可通过 `rpmbuild --rebuild <SRPM包路径>` 直接重建为二进制 RPM 包，无需手动编写 SPEC，适合二次定制打包、版本追溯及跨 RPM 系统分发，兼顾了源码的灵活性与 RPM 打包的标准化。                                                                              |

## SPEC 文件

SPEC 文件是用于描述 RPM 软件包构建流程的脚本文件，它通过标准化的语法和结构，向 `rpmbuild` 工具明确指定构建全流程的指令：包括源代码的获取与预处理、编译参数配置、安装路径定义、文件权限设置，以及包安装 / 卸载时的脚本执行逻辑。

SPEC 文件是 RPM 包构建体系的核心中枢，其编写质量直接决定了 RPM 包能否跨环境兼容、能否正确安装与运行。SPEC 文件的扩展名固定为 `.spec`，通常存放于 `~/rpmbuild/SPECS` 目录下。

SPEC 文件采用分段式结构，每个段落各司其职：

- **头部元数据**：定义软件包的基础信息：包名、版本号、发布号、摘要、许可证、源码地址、补丁文件等，是 RPM 包的身份标识
- **宏定义**：自定义变量或常量，用于简化重复配置（如安装路径、编译参数），提升 SPEC 文件的可维护性
- **依赖声明**：`BuildRequires` 指定编译阶段依赖（如 `gcc`、`make`）；`Requires` 指定运行阶段依赖（如 `glibc`）；带括号的为特定阶段依赖
- **补丁声明**：声明需要应用到源码的补丁文件，配合 `%prep` 阶段的 `%patch` 命令使用
- **准备阶段**（`%prep`）：执行源码预处理操作，例如解压源码包（常用 `%setup -q`）、应用补丁（`%patch0 -p1`）、创建临时目录等
- **构建阶段**（`%build`）：执行源码编译命令，如 `./configure` `配置编译参数、make` 执行编译，支持多核编译优化（`%{?_smp_mflags}`）
- **安装阶段**（`%install`）：将编译后的文件安装到临时构建根目录（`%{buildroot}`），而非直接安装到系统；需通过 `DESTDIR` 或 `PREFIX` 指定路径
- **清理阶段**（`%clean`）：可选段落，用于清理构建过程中产生的临时文件（现代 `rpmbuild` 会自动清理，该段落使用率降低）
- **文件列表**（%files）：明确最终 RPM 包包含的文件 / 目录，指定文件权限（`%defattr`）、标记文档（`%doc`）或配置文件（`%config(noreplace)`）
- **变更日志**（`%changelog`）：记录 RPM 包的版本变更历史，包括修改人、修改时间、修改内容，是规范 RPM 包的必备段落

SPEC 文件的语法和结构对于构建 RPM 包至关重要，它需要精确地描述构建过程，以确保软件包能够正确构建和安装。SPEC 文件通常以 `.spec` 为文件扩展名。

在 SPEC 文件中，宏（Macros） 是一种以 `%` 开头的特殊变量，会在 `rpmbuild` 执行时自动扩展为具体值。宏的核心价值是统一配置、提升跨环境兼容性，避免硬编码路径或参数。

宏的类型可以大致分为：

- 预定义宏：由 RPM 工具链内置，与系统架构、发行版强相关，无需手动定义即可直接使用。例如，`%{_prefix}` 默认为 `/usr`, `%{_bindir}` 默认为 `/usr/bin`, `%{_sysconfdir}` 默认为 `/etc` 等等，这些宏在构建时自动被替换为特定的值
- 条件宏：以 `%{?macro_name}` 格式出现的条件宏，如果 `macro_name` 被定义，则替换为 `macro_name` 的值，否则不替换
- 用户定义宏：用户可以在 SPEC 文件中自定义宏，通过 `%define macro_name value` 定义，然后在 SPEC 文件的其他部分使用 `%{macro_name}` 引用

## 编写 SPEC

使用 `.src.rpm`（源 RPM 包）构建二进制 RPM 时，SPEC 文件已由软件包维护者预先编写并内置于包中，用户无需手动创建；而从原始源码包（如 `tar.gz`）构建 RPM 包时，用户需自行编写 SPEC 文件以定义构建逻辑、文件清单及安装行为。

首先创建一个名为 `openssh10.2p1.spec` 的文件，并保存在 `~/rpmbuild/SPECS` 目录下：

```bash
mkdir -p ~/rpmbuild/SPECS
touch ~/rpmbuild/SPECS/openssh-10.2p1.spec
```

下载 `rpm-build` 工具集和 `openssl`：

```bash
dnf install -y rpm-build openssl openssl-devel
```

- `openssl`：核心主包，包含 `openssl` 命令、运行时库（libssl.so.3/libcrypto.so.3），提供 `rpmbuild` 所需的 3.4.0 + 版本符号。
- `openssl-devel`：开发库包，包含编译源码所需的头文件（如 openssl/ssl.h）和静态库，是重建源码包的必备依赖。

> [!WARNING]
> 必须确保 openssl 版本为 3.4.0 +，否则会报错，并会导致系统崩溃！

编写 SPEC 文件是一项细节繁多且流程复杂的工作。在实际生产环境中，通常优先使用官方制作并发布的 RPM 包，这类官方包不仅严格遵循系统打包规范，还会及时集成安全补丁、修复系统适配问题，能最大程度保障软件的稳定性和兼容性。

因此下文相关内容仅作为技术参考，实际项目中建议结合官方规范和业务场景选择合适的包，而非自行从头编写 SPEC 文件：

::: steps

1. 前置宏定义

    ```shell
    %define debug_package %{nil}
    ```

    `%define` 是 RPM 宏定义指令，用于自定义或覆盖内置宏。`debug_package` 是 RPM 内置宏，控制是否生成调试信息包（`-debuginfo`）。

    赋值为 `%{nil}` 表示禁用调试包生成，避免打包产出冗余的调试文件，减少包体积、缩短打包耗时，生产环境打包通用该配置。

2. 软件元数据

    ```shell
    Name:           openssh
    Version:        10.2p1
    Release:        1%{?dist}
    Summary:        Secure shell (SSH) client and server
    License:        BSD-2-Clause
    URL:            https://www.openssh.com/
    Source0:        https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-%{version}.tar.gz
    ```

    这是 RPM 包的「身份证信息」，定义了包的基本属性，每个字段都有固定含义：

    - `Name`：包基础名称，最终 rpm 文件名前缀
    - `Version`：上游软件原生版本，需与源码包版本完全匹配
    - `Release`：打包迭代版本，`%{?dist}` 为发行版标识宏（如 el9、el10）
    - `Summary`：包简短功能摘要，rpm 查询时展示
    - `License`：软件开源协议，需合规填写
    - `URL`：软件官方地址
    - `Source0`：源码包下载路径，rpmbuild会从该地址获取源码

3. 编译及运行依赖

    ```shell
    BuildRequires:  gcc make zlib-devel openssl-devel pam-devel libselinux-devel systemd pkgconfig
    Requires:       openssl-libs zlib pam libselinux
    ```

    这部分定义了打包过程中编译阶段和运行阶段的依赖关系，是 RPM 打包的核心配置之一：

    - `BuildRequires`：编译依赖，打包时（编译源码阶段）需要的软件包，只在打包时需要，安装 RPM 包时不需要（比如 `gcc` 是编译器，`xxx-devel` 是开发库，提供编译所需的头文件）
    - `Requires`：运行依赖，安装 RPM 包后，软件运行时需要的软件包，缺少的话，软件无法启动（比如 `openssl-libs` 是运行时需要的加密库，`pam` 是认证模块）

4. 主包描述

    ```shell
    %description
    OpenSSH is a free implementation of the SSH protocol suite for secure remote login and file transfer.
    ```

    `%description` 是对主包功能的详细说明（区别于 `Summary` 的简短摘要），当用户执行 `rpm -qi openssh` 时，会展示这段描述文本，用于清晰告知用户软件的核心用途。

5. 客户端子包定义

    ```shell
    %package clients
    Summary:        OpenSSH client programs
    Requires:       openssh = %{version}-%{release}
    Obsoletes:      openssh-clients < %{version}
    %description clients
    OpenSSH client programs for secure remote login and secure file transfer.
    ```

    - `%package clients`：定义 openssh-clients 子包，实现客户端与服务端分离打包
    - `Requires: openssh = %{version}-%{release}`：强制客户端子包与主包版本完全一致，避免版本不兼容
    - `Obsoletes: openssh-clients < %{version}`：当安装新版本时，自动淘汰低于当前版本的旧版客户端包
    - `%description clients`：仅针对客户端子包的功能描述

6. 服务端子包定义

    ```shell
    %package server
    Summary:        OpenSSH server daemon
    Requires:       openssh = %{version}-%{release}
    Obsoletes:      openssh-server < %{version}
    %description server
    OpenSSH server daemon for providing secure remote access to a system.
    ```

    与客户端子包逻辑一致，声明名为 openssh-server 的服务端子包：
    - 核心作用是拆分出 SSH 服务端功能，用户若仅需作为 SSH 客户端（如连接其他服务器），可只装 `openssh-clients`，无需安装服务端
    - `Requires`/`Obsoletes` 同样保证版本一致性和旧版淘汰逻辑

7. 预处理阶段（`%prep`）

    ```shell
    %prep
    %setup -q
    ```

    `%prep` 是 RPM 打包的「预处理阶段」，执行源码解压、补丁应用等准备工作：
    - `%setup` 是 RPM 内置宏，默认会将 `Source0` 定义的源码包解压到 `%{_builddir}`（通常是 `~/rpmbuild/BUILD`）
    - `-q` 参数表示「静默模式」，减少解压过程的冗余输出，让打包日志更简洁

    这一步完成后，后续的 `%build` 阶段会在解压后的源码目录中执行编译

8. 构建阶段（`%build`）

    ```shell
    %build
    ./configure \
        --prefix=/usr \
        --sysconfdir=/etc/ssh \
        --with-pam \
        --with-selinux \
        --with-zlib

    make %{?_smp_mflags}
    ```

    `%build` 是 RPM 打包的「编译构建阶段」，负责将源码编译为可执行程序：

    - `./configure`：生成编译配置，指定安装路径、配置文件目录，启用 PAM/SELinux/zlib 支持
    - `make %{?_smp_mflags}`：执行编译，`%{?_smp_mflags}` 是 RPM 内置宏，会自动识别服务器 CPU 核心数，并行编译（如 `-j4`），大幅提升编译速度

9. 安装阶段（`%install`）

    ```shell
    %install
    rm -rf %{buildroot}
    make install DESTDIR=%{buildroot}

    # 部署核心 SSH 配置文件
    install -D -m 644 /etc/ssh/sshd_config %{buildroot}/etc/ssh/sshd_config
    install -D -m 644 /etc/ssh/ssh_config %{buildroot}/etc/ssh/ssh_config
    install -D -m 644 /etc/ssh/moduli %{buildroot}/etc/ssh/moduli
    install -D -m 644 /usr/lib/systemd/system/sshd.service %{buildroot}/%{_unitdir}/sshd.service

    # 部署 sshd_config.d 子目录及配置
    mkdir -p %{buildroot}/etc/ssh/sshd_config.d/
    for conf in /etc/ssh/sshd_config.d/*.conf; do
        [ -f "$conf" ] && install -D -m 644 $conf %{buildroot}/$conf
    done

    # 部署 SSH 密钥文件
    for key in /etc/ssh/*key*; do
        [ -f "$key" ] && install -D -m 600 $key %{buildroot}/$key
    done

    # 部署 PAM 及 sysconfig 配置
    install -D -m 644 /etc/pam.d/sshd %{buildroot}/etc/pam.d/sshd
    install -D -m 644 /etc/sysconfig/sshd %{buildroot}/etc/sysconfig/sshd

    # 修正 sshd 权限
    chmod 755 %{buildroot}%{_sbindir}/sshd
    ```

    `%install` 是 RPM 打包的「安装阶段」，负责将编译好的文件部署到「虚拟根目录」（`%{buildroot}`，通常是 `~/rpmbuild/BUILDROOT`），最终会基于该目录打包成 RPM 文件：
    - `rm -rf %{buildroot}`：先清空虚拟根目录，避免残留旧文件导致打包错误
    - `make install DESTDIR=%{buildroot}`：将编译产物安装到虚拟根目录（而非真实系统目录）
    - `install -D -m 权限 源文件 目标文件`：`-D` 自动创建目标目录，`-m` 指定文件权限：
      - 配置文件权限 644（仅 root 可写，其他可读）
      - 密钥文件权限 600（仅 root 可读写，SSH 安全要求）
    - 循环拷贝 `sshd_config.d` 下的配置、SSH 密钥文件：保证所有相关配置 / 密钥都被纳入 RPM 包
    - chmod 755 修正 `sshd` 权限：移除不必要的 setuid 权限，降低安全风险

    这一步的核心目是拷贝 **当前系统中用户正在使用的 SSH 配置和密钥文** 件到 RPM 包，并后续配合 `%config(noreplace)` 标记，确保升级时不覆盖用户自定义的配置 / 密钥，保留现有生效的配置。

10. 文件清单

    > [!TIP]
    > 可以执行 `rpm -ql PACKAGE_NAME` 命令，查看已安装系统中该包实际包含的所有文件，以此核对并确定打包时需要保留的文件清单。
    >
    > 打包需要删除 /usr/libexec/openssh、/usr/share/doc/openssh/*、/usr/share/licenses/openssh 等文件清单，是因为这些目录是 Rocky/RHEL 系系统「官方打包规范」要求的统一文档、许可证存放路径，但 OpenSSH 源码包不了解该系统专属规范，编译后不会自动创建这些目录 / 文件，若保留这些不存在的路径，`rpmbuild` 打包时会因找不到文件而报错，因此需删除。

    主包文件清单：

    ```shell
    %files
    %config(noreplace) /etc/ssh/*
    %{_bindir}/ssh-keygen
    %{_mandir}/man1/ssh-keygen.1.gz
    ```

    `%files` 定义「主包」（openssh）包含的文件列表，RPM 打包时仅会将这些文件纳入主包。`%config(noreplace)` 标记该文件为配置文件，且升级 RPM 包时不覆盖用户已修改的配置（仅当文件不存在时才安装），是保护用户配置的核心参数。

    - `%{_bindir}`：是 RPM 系统级内置宏，默认指向 `/usr/libexec`，存放普通用户和管理员都能执行的通用命令
    - `%{_mandir}`：是 RPM 系统级内置宏，默认指向 `/usr/share/man`，存放所有命令的帮助文档

    客户端包文件清单：

    ```shell
    %files clients
    %{_bindir}/scp
    %{_bindir}/sftp
    %{_bindir}/ssh
    %{_bindir}/ssh-add
    %{_bindir}/ssh-agent
    %{_bindir}/ssh-keyscan
    %{_mandir}/man1/scp.1.gz
    %{_mandir}/man1/sftp.1.gz
    %{_mandir}/man1/ssh-add.1.gz
    %{_mandir}/man1/ssh-agent.1.gz
    %{_mandir}/man1/ssh-keyscan.1.gz
    %{_mandir}/man1/ssh.1.gz
    %{_mandir}/man5/ssh_config.5.gz
    %{_mandir}/man8/ssh-pkcs11-helper.8.gz
    %{_mandir}/man8/ssh-sk-helper.8.gz
    ```

    服务包文件清单：

    ```shell
    %files server
    %config(noreplace) /etc/pam.d/sshd
    %config(noreplace) /etc/sysconfig/sshd
    %{_unitdir}/sshd.service
    %{_libexecdir}/sftp-server
    %{_libexecdir}/ssh-*
    %{_libexecdir}/sshd-*
    %{_sbindir}/sshd
    %{_mandir}/man5/moduli.5.gz
    %{_mandir}/man5/sshd_config.5.gz
    %{_mandir}/man8/sftp-server.8.gz
    %{_mandir}/man8/sshd.8.gz
    %{_mandir}/man8/ssh-keysign.8.gz
    %{_mandir}/man8/ssh-pkcs11-helper.8.gz
    %{_mandir}/man8/ssh-sk-helper.8.gz
    ```

    - `%{_unitdir}`：是 RPM 系统级内置宏，默认指向 `/usr/lib/systemd/system`，专门存放控制系统服务启动 / 停止 / 自启的配置文件
    - `%{_sbindir}`：是 RPM 系统级内置宏，默认指向 `/usr/sbin`，存放仅管理员（root）才能执行的系统管理命令

11. 服务端升级后置脚本

    ```shell
    %post server
    if [ $1 -ne 1 ]; then
        systemctl daemon-reload >/dev/null 2>&1 || :
        systemctl try-restart sshd.service >/dev/null 2>&1 || :
    fi
    ```

    这个 `%post server` 脚本是 openssh-server 包的安装 / 升级后置脚本，核心逻辑是仅在升级 OpenSSH 服务端时重新加载配置并尝试重启服务，首次安装时不执行任何操作：

    - `if [ $1 -ne 1 ]`：条件判断，如果 `$1` 不等于 1（也就是升级 OpenSSH 服务端），执行下面命令；否则（首次安装）跳过
      - `systemctl daemon-reload`：重新加载 systemd 的服务配置。因为升级可能会更新 sshd.service 文件，这一步能让 systemd 识别到新的服务配置
      - `systemctl try-restart sshd.service`：尝试重启 `sshd` 服务，如果 `sshd` 正在运行，就重启它（让新配置生效）；如果 `sshd` 原本就没运行，就不做任何操作（避免误启动）
      - `>/dev/null 2>&1`：把命令的正常输出和错误输出都屏蔽掉，避免打包 / 安装时产生冗余日志
      - `|| :`即使前面的命令执行失败（比如系统没有 `systemd`、`sshd` 服务不存在），也不会返回非 0 错误码，保证脚本执行不中断，包安装 / 升级能正常完成

12. 服务端卸载后置脚本

    ```shell
    %postun server
    if [ $1 -eq 0 ]; then
        systemctl --no-reload disable sshd.service >/dev/null 2>&1 || :
        systemctl stop sshd.service >/dev/null 2>&1 || :
    fi
    ```

    这个 `%postun server` 脚本是 openssh-server 包的卸载 / 升级后置脚本（`%postun` 即 post-uninstall，卸载后执行），核心逻辑是仅在完全卸载 OpenSSH 服务端时禁用并停止 sshd 服务；升级包时（旧版本被临时卸载）不执行任何操作。

    - `if [ $1 -eq 0 ]`：条件判断，如果 `$1` 等于 0（也就是完全卸载 OpenSSH 服务端），执行下面命令；否则（升级）跳过
    - `systemctl --no-reload disable sshd.service`：禁用 sshd 服务，防止它在系统重启后自动启动
    - `systemctl stop sshd.service`：停止 sshd 服务，确保当前没有运行的 sshd 进程
    - `>/dev/null 2>&1`：把命令的正常输出和错误输出都屏蔽掉，避免打包 / 安装时产生冗余日志
    - `|| :`即使前面的命令执行失败（比如系统没有 `systemd`、`sshd` 服务不存在），也不会返回非 0 错误码，保证脚本执行不中断，包安装 / 升级能正常完成

13. 变更日志

    ```shell
    %changelog
    * Tue Feb 03 2026 Your Name <you@example.com> - 10.2p1-1
    - 升级至 OpenSSH 10.2p1 版本，升级过程中保留现有 SSH 配置、密钥及系统环境，不覆盖原有设置
    ```

    变更日志有严格要求：
    - 每条变更记录的开头格式固定为：`* 英文星期 英文月份 日期 年份 作者 <邮箱> - 版本号-发布号`
    - 每条具体变更必须以 `-` 开头，清晰描述变更目的（如升级版本、修复漏洞、优化配置），便于后续维护和问题追溯

:::

## 完整 SPEC 文件

:::code-group

```shell [~/rpmbuild/SPECS/openssh.spec]
%define debug_package %{nil}

Name:           openssh
Version:        10.2p1
Release:        1%{?dist}
Summary:        Secure shell (SSH) client and server
License:        BSD-2-Clause
URL:            https://www.openssh.com/
Source0:        https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-%{version}.tar.gz

BuildRequires:  gcc make zlib-devel openssl-devel pam-devel libselinux-devel systemd pkgconfig
Requires:       openssl-libs zlib pam libselinux

%description
OpenSSH is a free implementation of the SSH protocol suite for secure remote login and file transfer.

%package clients
Summary:        OpenSSH client programs
Requires:       openssh = %{version}-%{release}
Obsoletes:      openssh-clients < %{version}
%description clients
OpenSSH client programs for secure remote login and secure file transfer.

%package server
Summary:        OpenSSH server daemon
Requires:       openssh = %{version}-%{release}
Obsoletes:      openssh-server < %{version}
%description server
OpenSSH server daemon for providing secure remote access to a system.

%prep
%setup -q

%build
./configure \
    --prefix=/usr \
    --sysconfdir=/etc/ssh \
    --with-pam \
    --with-selinux \
    --with-zlib

make %{?_smp_mflags}

%install
rm -rf %{buildroot}
make install DESTDIR=%{buildroot}

install -D -m 644 /etc/ssh/sshd_config %{buildroot}/etc/ssh/sshd_config
install -D -m 644 /etc/ssh/ssh_config %{buildroot}/etc/ssh/ssh_config
install -D -m 644 /etc/ssh/moduli %{buildroot}/etc/ssh/moduli
install -D -m 644 /usr/lib/systemd/system/sshd.service %{buildroot}/%{_unitdir}/sshd.service

mkdir -p %{buildroot}/etc/ssh/sshd_config.d/
for conf in /etc/ssh/sshd_config.d/*.conf; do
    [ -f "$conf" ] && install -D -m 644 $conf %{buildroot}/$conf
done

for key in /etc/ssh/*key*; do
    [ -f "$key" ] && install -D -m 600 $key %{buildroot}/$key
done

install -D -m 644 /etc/pam.d/sshd %{buildroot}/etc/pam.d/sshd
install -D -m 644 /etc/sysconfig/sshd %{buildroot}/etc/sysconfig/sshd

chmod 755 %{buildroot}%{_sbindir}/sshd

%files
%config(noreplace) /etc/ssh/*
%{_bindir}/ssh-keygen
%{_mandir}/man1/ssh-keygen.1.gz

%files clients
%{_bindir}/scp
%{_bindir}/sftp
%{_bindir}/ssh
%{_bindir}/ssh-add
%{_bindir}/ssh-agent
%{_bindir}/ssh-keyscan
%{_mandir}/man1/scp.1.gz
%{_mandir}/man1/sftp.1.gz
%{_mandir}/man1/ssh-add.1.gz
%{_mandir}/man1/ssh-agent.1.gz
%{_mandir}/man1/ssh-keyscan.1.gz
%{_mandir}/man1/ssh.1.gz
%{_mandir}/man5/ssh_config.5.gz
%{_mandir}/man8/ssh-pkcs11-helper.8.gz
%{_mandir}/man8/ssh-sk-helper.8.gz

%files server
%config(noreplace) /etc/pam.d/sshd
%config(noreplace) /etc/sysconfig/sshd
%{_unitdir}/sshd.service
%{_libexecdir}/sftp-server
%{_libexecdir}/ssh-*
%{_libexecdir}/sshd-*
%{_sbindir}/sshd
%{_mandir}/man5/moduli.5.gz
%{_mandir}/man5/sshd_config.5.gz
%{_mandir}/man8/sftp-server.8.gz
%{_mandir}/man8/sshd.8.gz
%{_mandir}/man8/ssh-keysign.8.gz
%{_mandir}/man8/ssh-pkcs11-helper.8.gz
%{_mandir}/man8/ssh-sk-helper.8.gz

%post server
if [ $1 -ne 1 ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
    systemctl try-restart sshd.service >/dev/null 2>&1 || :
fi

%postun server
if [ $1 -eq 0 ]; then
    systemctl --no-reload disable sshd.service >/dev/null 2>&1 || :
    systemctl stop sshd.service >/dev/null 2>&1 || :
fi

%changelog
* Tue Feb 03 2026 Your Name <you@example.com> - 10.2p1-1
- 升级至 OpenSSH 10.2p1 版本，升级过程中保留现有 SSH 配置、密钥及系统环境，不覆盖原有设置
```

:::

## 构建与测试

然后下载最新的 OpenSSH 源码并将其放置在 `~/rpmbuild/SOURCES` 目录下：

```bash
mkdir ~/rpmbuild/SOURCES
wget https://mirrors.aliyun.com/pub/OpenBSD/OpenSSH/portable/openssh-10.2p1.tar.gz
mv openssh-10.2p1.tar.gz ~/rpmbuild/SOURCES/
```

安装相关依赖包：

```bash
dnf -y install gcc make zlib-devel openssl-devel pam-devel libselinux-devel systemd pkgconfig
```

验证 SPEC 文件：

```bash
rpmbuild -bd ~/rpmbuild/SPECS/openssh-10.2p1.spec
```

```console
setting SOURCE_DATE_EPOCH=1770076800
Executing(%prep): /bin/sh -e /var/tmp/rpm-tmp.INMZY2
+ umask 022
+ cd /root/rpmbuild/BUILD
+ cd /root/rpmbuild/BUILD
+ rm -rf openssh-10.2p1
+ /usr/lib/rpm/rpmuncompress -x /root/rpmbuild/SOURCES/openssh-10.2p1.tar.gz
+ STATUS=0
+ '[' 0 -ne 0 ']'
+ cd openssh-10.2p1
+ rm -rf /root/rpmbuild/BUILD/openssh-10.2p1-SPECPARTS
+ /usr/bin/mkdir -p /root/rpmbuild/BUILD/openssh-10.2p1-SPECPARTS
+ /usr/bin/chmod -Rf a+rX,u+w,g-w,o-w .
+ RPM_EC=0
++ jobs -p
+ exit 0
```

`-bd` 参数的含义是：b=build（构建），d=directory（仅执行到编译目录准备阶段），不生成最终的 RPM 安装包，仅完成源码解压 → 编译环境初始化 → 编译准备，用于提前验证：

- Spec 文件语法是否正确
- 源码包是否能正常解压
- 编译依赖是否完整（如果依赖缺失，此步骤会直接报错）

开始构建 RPM 包：

```bash
rpmbuild -ba ~/rpmbuild/SPECS/openssh-10.2p1.spec
```

查看构建结果：

```bash
tree ~/rpmbuild/
```

```console
/root/rpmbuild/
├── BUILD
├── BUILDROOT
├── RPMS
│   └── x86_64
│       ├── openssh-10.2p1-1.el10.x86_64.rpm
│       ├── openssh-clients-10.2p1-1.el10.x86_64.rpm
│       └── openssh-server-10.2p1-1.el10.x86_64.rpm
├── SOURCES
│   └── openssh-10.2p1.tar.gz
├── SPECS
│   └── openssh-10.2p1.spec
└── SRPMS
    └── openssh-10.2p1-1.el10.src.rpm
```

然后升级 OPENSSH：

```bash
rpm -Uvh ~/rpmbuild/RPMS/x86_64/openssh-*
```

```console
Verifying...                          ################################# [100%]
Preparing...                          ################################# [100%]
Updating / installing...
   1:openssh-10.2p1-1.el10            ################################# [ 17%]
   2:openssh-clients-10.2p1-1.el10    ################################# [ 33%]
   3:openssh-server-10.2p1-1.el10     ################################# [ 50%]
Cleaning up / removing...
   4:openssh-server-9.9p1-7.el10_0    ################################# [ 67%]
   5:openssh-clients-9.9p1-7.el10_0   ################################# [ 83%]
   6:openssh-9.9p1-7.el10_0           ################################# [100%]
Job for sshd.service failed because the control process exited with error code.
See "systemctl status sshd.service" and "journalctl -xeu sshd.service" for details.
```

出现报错和编译安装是一样的，将 `/etc/ssh/sshd_config.d/40-redhat-crypto-policies.conf` 文件中引入 `crypto-policies` 配置的 Include 行注释掉，避免 `sshd` 校验时加载无效配置：

```bash
sed -i 's|^Include /etc/crypto-policies/back-ends/opensshserver.config|#&|' /etc/ssh/sshd_config.d/40-redhat-crypto-policies.conf
```

然后重启 `sshd` 服务，可以正常启动：

```bash
systemctl restart sshd.service
```

通过查询 RPM 包信息可以确认升级成功：

```bash
rpm -qa | grep "openssh"
```

```console
openssh-10.2p1-1.el10.x86_64
openssh-clients-10.2p1-1.el10.x86_64
openssh-server-10.2p1-1.el10.x86_64
```

```bash
rpm -qi openssh
```

```console
Name        : openssh
Version     : 10.2p1
Release     : 1.el10
Architecture: x86_64
Install Date: Thu 05 Feb 2026 09:12:47 AM CST
Group       : Unspecified
Size        : 1031349
License     : BSD-2-Clause
Signature   : (none)
Source RPM  : openssh-10.2p1-1.el10.src.rpm
Build Date  : Thu 05 Feb 2026 08:59:05 AM CST
Build Host  : localhost
URL         : https://www.openssh.com/
Summary     : Secure shell (SSH) client and server
Description :
OpenSSH is a free implementation of the SSH protocol suite for secure remote login and file transfer.
```
